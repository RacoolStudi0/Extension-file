var ne=Object.defineProperty;var oe=(k,x,P)=>x in k?ne(k,x,{enumerable:!0,configurable:!0,writable:!0,value:P}):k[x]=P;var _=(k,x,P)=>oe(k,typeof x!="symbol"?x+"":x,P);(function(){"use strict";function k(m){return m&&m.__esModule&&Object.prototype.hasOwnProperty.call(m,"default")?m.default:m}var x={exports:{}},P=x.exports,U;function z(){return U||(U=1,function(m,a){(function(n,t){t(m)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:P,function(n){var t,o;if(!((o=(t=globalThis.chrome)==null?void 0:t.runtime)!=null&&o.id))throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const r="The message port closed before a response was received.",c=A=>{const T={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(T).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class M extends WeakMap{constructor(s,g=void 0){super(g),this.createItem=s}get(s){return this.has(s)||this.set(s,this.createItem(s)),super.get(s)}}const ee=e=>e&&typeof e=="object"&&typeof e.then=="function",q=(e,s)=>(...g)=>{A.runtime.lastError?e.reject(new Error(A.runtime.lastError.message)):s.singleCallbackArg||g.length<=1&&s.singleCallbackArg!==!1?e.resolve(g[0]):e.resolve(g)},$=e=>e==1?"argument":"arguments",re=(e,s)=>function(l,...d){if(d.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${$(s.minArgs)} for ${e}(), got ${d.length}`);if(d.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${$(s.maxArgs)} for ${e}(), got ${d.length}`);return new Promise((f,p)=>{if(s.fallbackToNoCallback)try{l[e](...d,q({resolve:f,reject:p},s))}catch(i){console.warn(`${e} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,i),l[e](...d),s.fallbackToNoCallback=!1,s.noCallback=!0,f()}else s.noCallback?(l[e](...d),f()):l[e](...d,q({resolve:f,reject:p},s))})},W=(e,s,g)=>new Proxy(s,{apply(l,d,f){return g.call(d,e,...f)}});let I=Function.call.bind(Object.prototype.hasOwnProperty);const N=(e,s={},g={})=>{let l=Object.create(null),d={has(p,i){return i in e||i in l},get(p,i,h){if(i in l)return l[i];if(!(i in e))return;let u=e[i];if(typeof u=="function")if(typeof s[i]=="function")u=W(e,e[i],s[i]);else if(I(g,i)){let C=re(i,g[i]);u=W(e,e[i],C)}else u=u.bind(e);else if(typeof u=="object"&&u!==null&&(I(s,i)||I(g,i)))u=N(u,s[i],g[i]);else if(I(g,"*"))u=N(u,s[i],g["*"]);else return Object.defineProperty(l,i,{configurable:!0,enumerable:!0,get(){return e[i]},set(C){e[i]=C}}),u;return l[i]=u,u},set(p,i,h,u){return i in l?l[i]=h:e[i]=h,!0},defineProperty(p,i,h){return Reflect.defineProperty(l,i,h)},deleteProperty(p,i){return Reflect.deleteProperty(l,i)}},f=Object.create(e);return new Proxy(f,d)},F=e=>({addListener(s,g,...l){s.addListener(e.get(g),...l)},hasListener(s,g){return s.hasListener(e.get(g))},removeListener(s,g){s.removeListener(e.get(g))}}),se=new M(e=>typeof e!="function"?e:function(g){const l=N(g,{},{getContent:{minArgs:0,maxArgs:0}});e(l)}),G=new M(e=>typeof e!="function"?e:function(g,l,d){let f=!1,p,i=new Promise(S=>{p=function(b){f=!0,S(b)}}),h;try{h=e(g,l,p)}catch(S){h=Promise.reject(S)}const u=h!==!0&&ee(h);if(h!==!0&&!u&&!f)return!1;const C=S=>{S.then(b=>{d(b)},b=>{let L;b&&(b instanceof Error||typeof b.message=="string")?L=b.message:L="An unexpected error occurred",d({__mozWebExtensionPolyfillReject__:!0,message:L})}).catch(b=>{console.error("Failed to send onMessage rejected reply",b)})};return C(u?h:i),!0}),te=({reject:e,resolve:s},g)=>{A.runtime.lastError?A.runtime.lastError.message===r?s():e(new Error(A.runtime.lastError.message)):g&&g.__mozWebExtensionPolyfillReject__?e(new Error(g.message)):s(g)},H=(e,s,g,...l)=>{if(l.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${$(s.minArgs)} for ${e}(), got ${l.length}`);if(l.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${$(s.maxArgs)} for ${e}(), got ${l.length}`);return new Promise((d,f)=>{const p=te.bind(null,{resolve:d,reject:f});l.push(p),g.sendMessage(...l)})},ae={devtools:{network:{onRequestFinished:F(se)}},runtime:{onMessage:F(G),onMessageExternal:F(G),sendMessage:H.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:H.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},B={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return T.privacy={network:{"*":B},services:{"*":B},websites:{"*":B}},N(A,ae,T)};n.exports=c(chrome)}else n.exports=globalThis.browser})}(x)),x.exports}var J=z();const v=k(J),D="bep51c8d86833613f1041e3c3b463f2eb1e",Z="https://tagai.nukhali.com/api",E=(m,a)=>{const n={image_push:"/image",image_get_data:"/image/list",login:"/login",login_code:"/login-code",registration:"/register",profile:"/api-profile",filters:"/filters?hl={lang}"};let t="";return n[m].indexOf("http")!=-1,t=n[m],Z+t};async function V(m){const a=new Headers;return a.append("x-api-key",m),a.append("Content-Type","application/json"),await fetch(E("profile"),{method:"GET",headers:a})}const y=class y{async getProfile(){try{console.log("ProfileService.ApiToken",y.ApiToken);const a=await V(y.ApiToken);return a.ok?{error:!1,data:(await a.json()).data}:{error:!0,data:await a.json()}}catch(a){return{error:!0,data:a}}}async logout(){await y.setProfileToken("logout")}static async setProfileToken(a){await v.storage.local.set({[D]:a}),y.ApiToken=a,console.log("setProfileToken ProfileService.ApiToken",a,y.ApiToken)}static async initProfileToken(){const a=await v.storage.local.get([D]);return a&&a[D]?(y.ApiToken=a[D],!0):!1}};_(y,"ApiToken","");let w=y;function K(m,a,n){return fetch(E("image_get_data"),{method:"POST",headers:{"Content-Type":"application/json","x-api-key":a},body:JSON.stringify({identifiers:m,contributor:n})})}function Q(m,a,n,t){const o=new FormData;o.append("image",m,a),o.append("identificator",a),o.append("contributor",t);const r=new Headers;return r.append("x-api-key",n),r.append("Accept","application/json"),fetch(E("image_push"),{method:"POST",redirect:"error",headers:r,body:o})}class j{async pushImage(a,n,t,o){try{const r=await Q(a,n,t,o);return r.ok?{error:!1,data:(await r.json()).data}:{error:!0,message:"response not ok",data:await r.json()}}catch(r){let c="An unknown error occurred.",A=null;return r instanceof TypeError?(c=`Network error: ${r.message}`,A=r):r instanceof DOMException?(c=`DOM error: ${r.name} - ${r.message}`,A=r):r instanceof Error?(c=`Runtime error: ${r.message}`,A=r):typeof r=="string"?(c=`Error: ${r}`,A=r):typeof r=="object"&&r!==null&&("message"in r&&typeof r.message=="string"?c=`Custom error: ${r.message}`:c="An unexpected object error occurred.",A=r),console.error("Error during image push:",r),{error:!0,message:c+" "+E("image_push"),data:A}}}async getImagesData(a,n){await w.initProfileToken();const t=await K(a,w.ApiToken,n);return console.log(t),t.ok?{error:!1,data:(await t.json()).data}:{error:!0,message:"response not ok",data:await t.json()}}async getPhotoTagResult(a,n,t){const o=await j.fetchImageBlob(a);await w.initProfileToken();const r=await this.pushImage(o,n,w.ApiToken,t);if(r.error)throw console.error("[BG v13] API validation failed: Missing or invalid 'data' object.",JSON.stringify(r)),new Error(r.data.message);return console.error("result",JSON.stringify(r)),r.data}static async fetchImageBlob(a){console.log("[BG v13] Fetching image blob...");const n=await fetch(a);if(!n.ok)throw new Error(`Failed to fetch image: ${n.status} ${n.statusText}`);const t=await n.blob();if(!t||t.size<10)throw new Error("Fetched image data is empty or too small.");return console.log(`[BG v13] Blob fetched. Size: ${t.size}`),t}}async function X(m,a){const n=new Headers;return n.append("Accept","application/json"),n.append("Content-Type","application/json"),await fetch(E("login_code"),{method:"POST",headers:n,body:JSON.stringify({code:m,hash:a})})}async function Y(m,a,n,t,o){const r=new Headers;return r.append("Accept","application/json"),r.append("Content-Type","application/json"),await fetch(E("registration"),{method:"POST",headers:r,body:JSON.stringify({name:m,surname:a,email:n,phone:t,password:o})})}const O=class O{async login(a,n){try{const t=await X(a,n);if(t.ok){const o=await t.json();return O.AuthToken=o.data.token,await w.setProfileToken(o.data.user.api_key),console.log(w.ApiToken),{error:!1,data:o.data.user}}else return{error:!0,message:(await t.json()).message,data:{}}}catch(t){return{error:!0,data:t}}}async register(a,n,t,o,r){try{const c=await Y(a,n,t,o,r);return c.ok?{error:!1,data:(await c.json()).data.user}:{error:!0,message:(await c.json()).message,data:{}}}catch(c){return{error:!0,data:c}}}async initRastockLogin(a){return new Promise((n,t)=>{v.runtime.sendMessage({action:"initRastockLogin",mode:a}).then(async o=>{o&&o.error?t(o):o?(await w.setProfileToken(o.data.api_key),n(o)):t({error:!0,message:"No data or error received from background script."})})})}};_(O,"AuthToken","");let R=O;v.runtime.onInstalled.addListener(m=>{console.log("Installing extension...")}),v.runtime.onMessage.addListener((m,a,n)=>{if(m.action==="fetchAIData"){const{imageUrl:t,contributor:o,identificator:r}=m;return(async()=>{try{const A=await new j().getPhotoTagResult(t,r,o);n({error:!1,index:0,title:A.title,description:A.description,keywords:A.keywords,timestamp:new Date().toISOString()})}catch(c){console.error("Error during AI data fetching:",c,t,t,o),n({description:"",keywords:[],timestamp:"",title:"",error:!0,message:c.message||"Failed to fetch AI data"})}})(),!0}else if(m.action==="initRastockLogin"){const t=chrome.identity.getRedirectURL(),o=`https://rastock.ai/extension-auth?popup=true&mode=${m.mode}&redirect_uri=${encodeURIComponent(t)}`;chrome.identity.launchWebAuthFlow({url:o,interactive:!0},async function(r){if(chrome.runtime.lastError){console.error("chrome.runtime.lastError",chrome.runtime.lastError);return}const c=new URL(r),A=c.searchParams.get("code"),T=c.searchParams.get("hash");if(A&&T){console.log("Authorization Code:",A,T);const M=new R;n(await M.login(A,T))}else console.error("Authentication failed.")})}else if(m.action==="fetchGeneratedAIData"){const{identifiers:t,contributor:o}=m;return(async()=>{try{const c=await new j().getImagesData(t,o);n({error:!1,data:c.data,timestamp:new Date().toISOString()})}catch(r){console.error("Error during fetchGeneratedAIData data fetching:",r),n({data:[],timestamp:"",title:"",error:!0,message:r.message||"Failed to fetch fetchGeneratedAIData data"})}})(),!0}return!0})})();
